version: '3'

services:
  scrapoxy:
    image: scrapoxy/scrapoxy
    container_name: scrapoxy
    restart: always
    environment:
      - NODE_ENV=production
      - AUTH_LOCAL_USERNAME=${AUTH_LOCAL_USERNAME}
      - AUTH_LOCAL_PASSWORD=${AUTH_LOCAL_PASSWORD}
      - BACKEND_JWT_SECRET=${BACKEND_JWT_SECRET}
      - FRONTEND_JWT_SECRET=${FRONTEND_JWT_SECRET}
      - STORAGE_FILE_FILENAME=/app/storage/scrapoxy.json
      # Add other necessary Scrapoxy env vars here
    ports:
      - "${COMMANDER_PORT:-8889}:8890" # Commander GUI (Container listens on 8890)
      # Proxy port 8888 is not exposed to host, only to the forwarder network
    volumes:
      - ./scrapoxy-data:/app/storage # Persistence
    networks:
      - scrapoxy-net
    # Enterprise: Log rotation to prevent disk fill-up
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Enterprise: Resource limits to prevent out-of-control memory usage
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    # Enterprise: Healthcheck to ensure service is responsive
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8890"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  proxy-forwarder:
    build: ./proxy-forwarder
    container_name: scrapoxy-noauth-forwarder
    restart: always
    environment:
      - PORT=8890
      - UPSTREAM_HOST=scrapoxy
      - UPSTREAM_PORT=8888
      - UPSTREAM_USERNAME=${PROJECT_PROXY_USERNAME}
      - UPSTREAM_PASSWORD=${PROJECT_PROXY_PASSWORD}
    ports:
      - "${PROXY_PORT:-8890}:8890"
    depends_on:
      scrapoxy:
        condition: service_healthy
    networks:
      - scrapoxy-net
    # Enterprise: Log rotation
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # Enterprise: Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 64M
    # Enterprise: Healthcheck
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8890"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  scrapoxy-net:
    driver: bridge
